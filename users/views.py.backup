import stripe
from django.shortcuts import get_object_or_404
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action, api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from django_filters.contrib.auth import get_user_model
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import OrderingFilter
from drf_spectacular.utils import extend_schema

from config import settings
from courses.services.stripe_service import StripeService
from .models import Payment
from .serializers import UserSerializer, UserRegisterSerializer, PaymentSerializer, PaymentCreateSerializer
from .permissions import IsOwner, IsModerator
import logging

logger = logging.getLogger(__name__)

User = get_user_model()


class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer

    def get_serializer_class(self):
        if self.action == 'create':
            return UserRegisterSerializer
        return UserSerializer

    def get_permissions(self):
        """
        Настраиваем права доступа
        """
        if self.action == 'create':
            # Регистрация доступна всем
            permission_classes = [permissions.AllowAny]
        elif self.action in ['update', 'partial_update', 'destroy']:
            # Изменять и удалять можно только свой профиль
            permission_classes = [permissions.IsAuthenticated, IsOwner]
        else:
            # Просматривать профили могут все авторизованные
            permission_classes = [permissions.IsAuthenticated]
        return [permission() for permission in permission_classes]

    @action(detail=False, methods=['get', 'put', 'patch'])
    def me(self, request):
        """
        Получение и обновление профиля текущего пользователя
        """
        if request.method == 'GET':
            serializer = self.get_serializer(request.user)
            return Response(serializer.data)
        elif request.method in ['PUT', 'PATCH']:
            serializer = self.get_serializer(
                request.user,
                data=request.data,
                partial=(request.method == 'PATCH')
            )
            serializer.is_valid(raise_exception=True)
            serializer.save()
            return Response(serializer.data)
        return None


class PaymentViewSet(viewsets.ModelViewSet):
    queryset = Payment.objects.all()
    serializer_class = PaymentSerializer
    filter_backends = [DjangoFilterBackend, OrderingFilter]
    filterset_fields = ['paid_course', 'paid_lesson', 'payment_method', 'status']
    ordering_fields = ['created_at', 'amount']

    def get_permissions(self):
        if self.action in ['create', 'update', 'partial_update', 'destroy', 'buy', 'my_payments']:
            return [permissions.IsAuthenticated()]
        return [permissions.AllowAny()]

    def get_queryset(self):
        """Фильтрация платежей для текущего пользователя"""
        queryset = super().get_queryset()

        # Если пользователь аутентифицирован, показываем только его платежи
        if self.request.user.is_authenticated and self.action in ['list', 'retrieve']:
            queryset = queryset.filter(user=self.request.user)

        return queryset

    def perform_create(self, serializer):
        """Автоматически устанавливаем пользователя при создании платежа"""
        serializer.save(user=self.request.user)

    @extend_schema(
        summary="Создать платеж через Stripe",
        description="Создает платежную сессию Stripe для оплаты курса или урока",
        request=PaymentCreateSerializer,
        responses={
            201: {
                'description': 'Платежная сессия создана',
                'examples': {
                    'application/json': {
                        'message': 'Платеж создан',
                        'payment_id': 1,
                        'payment_url': 'https://checkout.stripe.com/pay/cs_test_...',
                        'session_id': 'cs_test_...',
                        'amount': 1999.99,
                        'item_type': 'course',
                        'item_name': 'Название курса'
                    }
                }
            }
        },
        tags=['Платежи']
    )
    @action(detail=False, methods=['post'], url_path='buy')
    def buy(self, request):
        """Создание платежной сессии Stripe"""
        from courses.models import Course, Lesson

        serializer = PaymentCreateSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

        try:
            item_type = serializer.validated_data['item_type']
            item_id = serializer.validated_data['item_id']
            user = request.user

            # Получаем оплачиваемый объект
            if item_type == 'course':
                item = get_object_or_404(Course, id=item_id)
                amount = item.price
                item_name = item.title
            else:  # lesson
                item = get_object_or_404(Lesson, id=item_id)
                amount = item.price
                item_name = item.title

            # Проверяем, не куплено ли уже
            existing_payment = Payment.objects.filter(
                user=user,
                paid_course=item if item_type == 'course' else None,
                paid_lesson=item if item_type == 'lesson' else None,
                status='paid'
            ).exists()

            if existing_payment:
                return Response(
                    {'detail': 'Вы уже приобрели этот элемент'},
                    status=status.HTTP_400_BAD_REQUEST
                )

            # Получаем или создаем Stripe ID
            stripe_product_id = item.stripe_product_id
            stripe_price_id = item.stripe_price_id

            # Если нет Stripe ID, создаем их
            if not stripe_product_id or not stripe_price_id:
                logger.info(f"Создаем Stripe продукт для {item_type} '{item_name}'")

                product = StripeService.create_product(
                    name=item_name,
                    description=f"Оплата за {item_type}: {item_name}"
                )

                price = StripeService.create_price(
                    product_id=product.id,
                    amount=float(amount),  # Убедитесь, что это float
                    currency='rub'
                )

                # Сохраняем ID в модель
                item.stripe_product_id = product.id
                item.stripe_price_id = price.id
                item.save()

                stripe_product_id = product.id
                stripe_price_id = price.id
                logger.info(f"Созданы Stripe ID: product={product.id}, price={price.id}")
            else:
                logger.info(f"Используем существующие Stripe ID для {item_type} {item_id}")

            # Создаем сессию оплаты
            session = StripeService.create_checkout_session(
                price_id=stripe_price_id,
                user_id=user.id,
                item_id=item.id,
                item_type=item_type,
                success_url=serializer.validated_data.get('success_url'),
                cancel_url=serializer.validated_data.get('cancel_url')
            )

            # Сохраняем платеж в БД
            payment_data = {
                'user': user,
                'amount': amount,
                'currency': 'rub',
                'payment_method': 'stripe',
                'stripe_session_id': session.id,
                'stripe_product_id': stripe_product_id,
                'stripe_price_id': stripe_price_id,
                'payment_url': session.url,
                'status': 'pending'
            }

            if item_type == 'course':
                payment_data['paid_course'] = item
            else:
                payment_data['paid_lesson'] = item

            payment = Payment.objects.create(**payment_data)
            logger.info(f"Создан платеж {payment.id} для пользователя {user.email}")

            return Response({
                'message': 'Платеж создан',
                'payment_id': payment.id,
                'payment_url': session.url,
                'session_id': session.id,
                'amount': float(amount),
                'item_type': item_type,
                'item_name': item_name
            }, status=status.HTTP_201_CREATED)

        except Exception as e:
            logger.error(f"Ошибка создания платежа: {e}")
            logger.exception("Полная трассировка ошибки:")  # Добавьте для деталей
            return Response(
                {'detail': f'Ошибка при создании платежа: {str(e)}'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @extend_schema(
        summary="Проверить статус платежа",
        description="Проверяет актуальный статус платежа через Stripe API",
        tags=['Платежи']
    )
    @action(detail=True, methods=['get'], url_path='status')
    def payment_status(self, request, pk=None):
        """Проверка статуса платежа через Stripe"""
        payment = self.get_object()

        # Обновляем статус из Stripe
        if payment.stripe_session_id:
            try:
                session = StripeService.retrieve_session(payment.stripe_session_id)

                if session.payment_status == 'paid' and payment.status != 'paid':
                    payment.status = 'paid'
                    payment.stripe_payment_intent_id = session.payment_intent
                    payment.save()
                elif session.payment_status == 'unpaid' and payment.status == 'paid':
                    payment.status = 'pending'
                    payment.save()

            except Exception as e:
                logger.error(f"Ошибка обновления статуса платежа: {e}")

        serializer = self.get_serializer(payment)
        return Response(serializer.data)

    @extend_schema(
        summary="Мои платежи",
        description="Получить список всех платежей текущего пользователя",
        tags=['Платежи']
    )
    @action(detail=False, methods=['get'], url_path='my')
    def my_payments(self, request):
        """Получить все платежи текущего пользователя"""
        payments = Payment.objects.filter(user=request.user).order_by('-created_at')
        serializer = self.get_serializer(payments, many=True)
        return Response(serializer.data)


# ============================================================================
# ОТДЕЛЬНЫЕ VIEW-ФУНКЦИИ ДЛЯ STRIPE РЕДИРЕКТОВ
# ============================================================================

@extend_schema(
    summary="Успешная оплата",
    description="Обработка успешного редиректа от Stripe после оплаты",
    tags=['Платежи'],
    methods=['GET'],
    exclude=True
)
@api_view(['GET'])
@permission_classes([AllowAny])
def payment_success(request):
    """Обработка редиректа после успешной оплаты в Stripe"""
    session_id = request.GET.get('session_id')

    if not session_id:
        return Response(
            {'error': 'Отсутствует session_id'},
            status=400
        )

    try:
        # Получаем платеж по session_id Stripe
        payment = Payment.objects.get(stripe_session_id=session_id)

        # Проверяем статус в Stripe
        stripe_session = StripeService.retrieve_session(session_id)

        if stripe_session.payment_status == 'paid' and payment.status != 'paid':
            # Обновляем статус платежа
            payment.status = 'paid'
            payment.stripe_payment_intent_id = stripe_session.payment_intent
            payment.save()

            logger.info(f"Платеж {payment.id} успешно завершен")

            # HTML ответ для браузера
            item_name = payment.paid_course.title if payment.paid_course else payment.paid_lesson.title

            html_content = f"""
            <html>
            <head>
                <title>Оплата успешна</title>
                <style>
                    body {{
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 50px;
                        background-color: #f5f5f5;
                    }}
                    .container {{
                        background-color: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        max-width: 600px;
                        margin: 0 auto;
                    }}
                    .success-icon {{
                        color: #4CAF50;
                        font-size: 48px;
                        margin-bottom: 20px;
                    }}
                    a {{
                        display: inline-block;
                        margin-top: 20px;
                        padding: 10px 20px;
                        background-color: #4CAF50;
                        color: white;
                        text-decoration: none;
                        border-radius: 5px;
                    }}
                    a:hover {{
                        background-color: #45a049;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="success-icon">✅</div>
                    <h1>Оплата успешно завершена!</h1>
                    <p><strong>ID платежа:</strong> {payment.id}</p>
                    <p><strong>Товар:</strong> {item_name}</p>
                    <p><strong>Сумма:</strong> {payment.amount} {payment.currency}</p>
                    <p><strong>Дата:</strong> {payment.created_at.strftime('%d.%m.%Y %H:%M')}</p>
                    <p>Спасибо за покупку!</p>
                    <a href="/api/docs/">Вернуться к документации API</a>
                </div>
            </body>
            </html>
            """

            return Response(html_content, content_type='text/html')

        elif payment.status == 'paid':
            # Платеж уже был оплачен
            html_content = f"""
            <html>
            <head>
                <title>Оплата уже обработана</title>
                <style>
                    body {{
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 50px;
                        background-color: #f5f5f5;
                    }}
                    .container {{
                        background-color: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        max-width: 600px;
                        margin: 0 auto;
                    }}
                    a {{
                        display: inline-block;
                        margin-top: 20px;
                        padding: 10px 20px;
                        background-color: #007BFF;
                        color: white;
                        text-decoration: none;
                        border-radius: 5px;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>ℹ️ Платеж уже был обработан</h1>
                    <p>Этот платеж уже был успешно обработан ранее.</p>
                    <p><strong>ID платежа:</strong> {payment.id}</p>
                    <a href="/api/docs/">Вернуться к документации API</a>
                </div>
            </body>
            </html>
            """

            return Response(html_content, content_type='text/html')
        else:
            # Платеж еще не оплачен
            html_content = f"""
            <html>
            <head>
                <title>Оплата ожидает</title>
                <style>
                    body {{
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 50px;
                        background-color: #f5f5f5;
                    }}
                    .container {{
                        background-color: white;
                        padding: 30px;
                        border-radius: 10px;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        max-width: 600px;
                        margin: 0 auto;
                    }}
                    .waiting-icon {{
                        color: #FFA500;
                        font-size: 48px;
                        margin-bottom: 20px;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="waiting-icon">⏳</div>
                    <h1>Оплата ожидает обработки</h1>
                    <p>Статус платежа: <strong>{payment.status}</strong></p>
                    <p>Пожалуйста, подождите или обновите страницу через несколько минут.</p>
                    <p><a href="/api/docs/">Вернуться к документации API</a></p>
                </div>
            </body>
            </html>
            """

            return Response(html_content, content_type='text/html', status=402)

    except Payment.DoesNotExist:
        logger.error(f"Платеж с session_id {session_id} не найден")

        html_content = """
        <html>
        <head>
            <title>Платеж не найден</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    text-align: center;
                    padding: 50px;
                    background-color: #f5f5f5;
                }
                .container {
                    background-color: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    max-width: 600px;
                    margin: 0 auto;
                }
                .error-icon {
                    color: #dc3545;
                    font-size: 48px;
                    margin-bottom: 20px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="error-icon">❌</div>
                <h1>Платеж не найден</h1>
                <p>Платеж с указанным session_id не найден в системе.</p>
                <p>Пожалуйста, проверьте правильность ссылки или обратитесь в поддержку.</p>
            </div>
        </body>
        </html>
        """

        return Response(html_content, content_type='text/html', status=404)

    except Exception as e:
        logger.error(f"Ошибка обработки успешной оплаты: {e}")

        html_content = f"""
        <html>
        <head>
            <title>Ошибка обработки</title>
            <style>
                body {{
                    font-family: Arial, sans-serif;
                    text-align: center;
                    padding: 50px;
                    background-color: #f5f5f5;
                }}
                .container {{
                    background-color: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    max-width: 600px;
                    margin: 0 auto;
                }}
                .error-icon {{
                    color: #dc3545;
                    font-size: 48px;
                    margin-bottom: 20px;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="error-icon">⚠️</div>
                <h1>Ошибка обработки оплаты</h1>
                <p>Произошла внутренняя ошибка сервера при обработке платежа.</p>
                <p>Пожалуйста, попробуйте позже или обратитесь в поддержку.</p>
            </div>
        </body>
        </html>
        """

        return Response(html_content, content_type='text/html', status=500)


@extend_schema(
    summary="Отмена оплаты",
    description="Обработка редиректа при отмене оплаты в Stripe",
    tags=['Платежи'],
    methods=['GET'],
    exclude=True
)
@api_view(['GET'])
@permission_classes([AllowAny])
def payment_cancel(request):
    """Обработка редиректа при отмене оплаты в Stripe"""
    session_id = request.GET.get('session_id')

    if session_id:
        try:
            payment = Payment.objects.get(stripe_session_id=session_id)
            payment.status = 'cancelled'
            payment.save()
            logger.info(f"Платеж {payment.id} отменен пользователем")
        except Payment.DoesNotExist:
            pass

    # HTML ответ для браузера
    html_content = """
    <html>
    <head>
        <title>Оплата отменена</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 50px;
                background-color: #f5f5f5;
            }
            .container {
                background-color: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                max-width: 600px;
                margin: 0 auto;
            }
            .cancel-icon {
                color: #dc3545;
                font-size: 48px;
                margin-bottom: 20px;
            }
            a {
                display: inline-block;
                margin-top: 20px;
                padding: 10px 20px;
                background-color: #007BFF;
                color: white;
                text-decoration: none;
                border-radius: 5px;
            }
            a:hover {
                background-color: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="cancel-icon">❌</div>
            <h1>Оплата отменена</h1>
            <p>Вы отменили процесс оплаты.</p>
            <p>Вы можете вернуться на страницу курса/урока и повторить попытку оплаты.</p>
            <a href="/api/docs/">Вернуться к документации API</a>
        </div>
    </body>
    </html>
    """

    return Response(html_content, content_type='text/html')


@extend_schema(
    summary="Вебхук Stripe",
    description="Получение событий от Stripe (рекомендуется для продакшена)",
    tags=['Платежи'],
    methods=['POST'],
    exclude=True
)
@api_view(['POST'])
@permission_classes([AllowAny])
def stripe_webhook(request):
    """
    Обработчик вебхуков от Stripe.
    Настройте вебхук в Stripe Dashboard на этот URL.
    """
    payload = request.body
    sig_header = request.headers.get('Stripe-Signature')
    webhook_secret = getattr(settings, 'STRIPE_WEBHOOK_SECRET', '')

    if not webhook_secret:
        logger.warning("STRIPE_WEBHOOK_SECRET не настроен")
        return Response({'error': 'Webhook секрет не настроен'}, status=400)

    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, webhook_secret
        )
    except ValueError as e:
        # Invalid payload
        logger.error(f"Неверный payload вебхука: {e}")
        return Response({'error': str(e)}, status=400)
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
        logger.error(f"Неверная подпись вебхука: {e}")
        return Response({'error': str(e)}, status=400)

    # Обработка событий
    event_type = event['type']
    logger.info(f"Получено событие Stripe: {event_type}")

    if event_type == 'checkout.session.completed':
        session = event['data']['object']

        try:
            payment = Payment.objects.get(stripe_session_id=session['id'])

            if session['payment_status'] == 'paid' and payment.status != 'paid':
                payment.status = 'paid'
                payment.stripe_payment_intent_id = session.get('payment_intent')
                payment.save()

                logger.info(f"Платеж {payment.id} отмечен как оплаченный через вебхук")

                # Здесь можно добавить дополнительную логику:
                # - Отправить email пользователю
                # - Активировать доступ к курсу
                # - Обновить статистику

        except Payment.DoesNotExist:
            logger.error(f"Платеж с session_id {session['id']} не найден")

    elif event_type == 'checkout.session.expired':
        session = event['data']['object']

        try:
            payment = Payment.objects.get(stripe_session_id=session['id'])
            payment.status = 'cancelled'
            payment.save()
            logger.info(f"Платеж {payment.id} истек")
        except Payment.DoesNotExist:
            pass

    elif event_type == 'payment_intent.succeeded':
        # Дополнительная обработка успешного платежа
        payment_intent = event['data']['object']
        logger.info(f"PaymentIntent успешен: {payment_intent['id']}")

    elif event_type == 'payment_intent.payment_failed':
        # Обработка неудачного платежа
        payment_intent = event['data']['object']
        logger.warning(f"PaymentIntent не удался: {payment_intent['id']}")

    return Response({'status': 'success', 'event': event_type})

@extend_schema(
    summary="Тестовый эндпоинт для проверки кодировки",
    description="Проверяет корректность работы UTF-8 кодировки в API",
    tags=['Тестирование']
)
@api_view(['GET'])
@permission_classes([AllowAny])
def test_encoding(request):
    """Тестовый эндпоинт для проверки кодировки"""
    return Response({
        "message": "Тест русских символов",
        "data": {
            "city": "Москва",
            "name": "Иван Петров",
            "description": "Тестирование кодировки UTF-8 в Django DRF"
        },
        "status": "success",
        "test": "Привет мир! Санкт-Петербург, Казань, Екатеринбург"
    })
